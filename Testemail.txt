package com.scb.scroeconnect.solaceworker.dto;

public class BodyDTO {
    private String physicalAccountNbr;
    private String iban;
    private String accountCurrency;
    private String accountCountry;
    private String vaNumber;
    private String vaultNbr;
    private String amount;
    private String crDrIndicator;
    private String txnDate;
    private String cbValueDate;
    private String sourceChannelId;
    private String txnReferenceNo;
    private String relatedReferenceNo;
    private String rtatransID;
    private String appSeqNo;
    private String narration_1;
    private String narration_2;
    private String narration_3;
    private String narration_4;
    private String narration_5;
    private String narration_6;

}

package com.scb.scroeconnect.solaceworker.dto;

public class HeaderDTO {
    private String notificationType;
}

package com.scb.scroeconnect.solaceworker.dto;

import lombok.AllArgsConstructor;
import lombok.Data;
import lombok.NoArgsConstructor;

import java.util.Date;
import java.util.List;

@Data
@AllArgsConstructor
public class SolacePayloadDTO {
    private String message_id;
    private HeaderDTO header;
    private List<BodyDTO> body;
    private TrailerDTO trailer;
    private Date initiated_timestamp;

    public SolacePayloadDTO() {
    }

}

package com.scb.scroeconnect.solaceworker.dto;

public class TrailerDTO {
    private String recordCount;
}

package com.scb.scroeconnect.solaceworker.entity;

import com.scb.scroeconnect.solaceworker.converter.SolacePayloadConverter;
import com.scb.scroeconnect.solaceworker.dto.SolacePayloadDTO;
import jakarta.persistence.*;

import java.util.Date;

@Entity
@Table(name = "connect_notification_delivery")
public class ConnectNotificationDelivery {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    @Column(name = "id")
    private Long id;

    @Convert(converter = SolacePayloadConverter.class)
    @Column(name = "transformed_payload", columnDefinition = "TEXT")
    private SolacePayloadDTO transformedPayload;

    @Column(name = "delivery_mode")
    private String delivery_mode;

    @Column(name = "status")
    private String status;

    @Column(name = "retry_count")
    private int retryCount;

    @Column(name = "available_at")
    private Date available_at;

    @Column(name = "updated_at")
    private Date updated_at;

    public ConnectNotificationDelivery() {
    }

    public ConnectNotificationDelivery(SolacePayloadDTO transformedPayload, String delivery_mode, String status) {
        this.transformedPayload = transformedPayload;
        this.delivery_mode = delivery_mode;
        this.status = status;
        this.available_at = new Date();
        this.updated_at = new Date();
    }

    public Long getId() {
        return id;
    }

    public void setId(Long id) {
        this.id = id;
    }

    public String getDelivery_mode() {
        return delivery_mode;
    }

    public void setDelivery_mode(String delivery_mode) {
        this.delivery_mode = delivery_mode;
    }

    public String getStatus() {
        return status;
    }

    public void setStatus(String status) {
        this.status = status;
    }

    public SolacePayloadDTO getTransformedPayload() {
        return transformedPayload;
    }

    public void setTransformedPayload(SolacePayloadDTO transformedPayload) {
        this.transformedPayload = transformedPayload;
    }

    public int getRetryCount() {
        return retryCount;
    }

    public void setRetryCount(int retryCount) {
        this.retryCount = retryCount;
    }

    public Date getAvailable_at() {
        return available_at;
    }

    public void setAvailable_at(Date available_at) {
        this.available_at = available_at;
    }

    public Date getUpdated_at() {
        return updated_at;
    }

    public void setUpdated_at(Date updated_at) {
        this.updated_at = updated_at;
    }
}

package com.scb.scroeconnect.solaceworker.entity;

import jakarta.persistence.Column;
import jakarta.persistence.Entity;
import jakarta.persistence.Id;
import jakarta.persistence.Table;

import java.util.Date;

@Entity
@Table(name = "connect_solace_config")
public class ConnectSolaceConfig {

    @Id
    @Column(name = "solace_config_id", nullable = false)
    private Long solaceConfigId;

    @Column(name = "host", nullable = false)
    private String host;

    @Column(name = "topic", nullable = false)
    private String topic;

    @Column(name = "vpn", nullable = false)
    private String vpn;

    @Column(name = "username", nullable = false)
    private String username;

    @Column(name = "password", nullable = false)
    private String password;

    @Column(name = "active", nullable = false)
    private String active;

    @Column(name = "created_at", nullable = false)
    private Date createdAt;

    @Column(name = "updated_at")
    private Date updatedAt;

    public ConnectSolaceConfig() {
    }

    public Long getSolaceConfigId() {
        return solaceConfigId;
    }

    public void setSolaceConfigId(Long solaceConfigId) {
        this.solaceConfigId = solaceConfigId;
    }

    public String getHost() {
        return host;
    }

    public void setHost(String host) {
        this.host = host;
    }

    public String getTopic() {
        return topic;
    }

    public void setTopic(String topic) {
        this.topic = topic;
    }

    public Date getCreatedAt() {
        return createdAt;
    }

    public void setCreatedAt(Date createdAt) {
        this.createdAt = createdAt;
    }

    public Date getUpdatedAt() {
        return updatedAt;
    }

    public void setUpdatedAt(Date updatedAt) {
        this.updatedAt = updatedAt;
    }

    public String getActive() {
        return active;
    }

    public void setActive(String active) {
        this.active = active;
    }

    public String getVpn() {
        return vpn;
    }

    public void setVpn(String vpn) {
        this.vpn = vpn;
    }

    public String getUsername() {
        return username;
    }

    public void setUsername(String username) {
        this.username = username;
    }

    public String getPassword() {
        return password;
    }

    public void setPassword(String password) {
        this.password = password;
    }
}

package com.scb.scroeconnect.solaceworker.enums;

public enum DeliveryStatus {
    PENDING,
    SENT,
    RETRY,
}

package com.scb.scroeconnect.solaceworker.repository;

import com.scb.scroeconnect.solaceworker.entity.ConnectNotificationDelivery;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.data.jpa.repository.Modifying;
import org.springframework.data.jpa.repository.Query;
import org.springframework.data.repository.query.Param;
import org.springframework.transaction.annotation.Transactional;

import java.util.Date;
import java.util.List;

public interface ConnectNotificationDeliveryRepository extends JpaRepository<ConnectNotificationDelivery, Long> {

    @Transactional
    @Query(value = """
            UPDATE connect_notification_delivery
            SET status = 'PROCESSING',
                updated_at = NOW()
            WHERE id IN (
                SELECT id
                FROM notification_delivery
                WHERE status IN ('PENDING', 'RETRY') :status
                    AND delivery_mode = 'Solace'
                    AND (available_at IS NULL OR available_at <= NOW())
                ORDER BY id
                FOR UPDATE SKIP LOCKED
                LIMIT :batchSize
            )
            RETURNING id, event_id, recipient_id, template_id, final_payload, retry count
            """, nativeQuery = true)
    List<ConnectNotificationDelivery> findPendingSolaceDeliveries(@Param("batchSize") int batchSize);

    @Modifying
    @Transactional
    @Query(value = "UPDATE connect_notification_delivery SET status = :status, " +
            "retry_count = retry_count + 1, available_at = :availableAt, updated_at = NOW() WHERE id = :id")
    void updateStatusAndRetryById(Long id, String status, Date availableAt);

    @Modifying
    @Transactional
    @Query(value = "UPDATE connect_notification_delivery SET status = :status, " +
            "updated_at = NOW() WHERE id = :id")
    void markSent(Long id, String status);

}

package com.scb.scroeconnect.solaceworker.repository;

import com.scb.scroeconnect.solaceworker.entity.ConnectSolaceConfig;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.data.jpa.repository.Query;
import org.springframework.stereotype.Repository;

import java.util.Optional;

@Repository
public interface ConnectSolaceConfigRepository extends JpaRepository<ConnectSolaceConfig, Long> {

    @Query(value = "SELECT topic, host, vpn, username, password FROM connect_solace_config WHERE active = 'Y'")
    Optional<ConnectSolaceConfig> findBySolaceInfoId();
}

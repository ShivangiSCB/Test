package com.scb.scroeconnect.emailworker.service;

import com.fasterxml.jackson.core.JsonProcessingException;
import com.fasterxml.jackson.databind.ObjectMapper;
import com.fasterxml.jackson.databind.node.ObjectNode;
import com.scb.scroeconnect.emailworker.config.EmailWorkerConfig;
import com.scb.scroeconnect.emailworker.config.RetryableRestTemplate;
import com.scb.scroeconnect.emailworker.dto.ContentBodyDTO;
import com.scb.scroeconnect.emailworker.dto.EmailRequestDTO;
import com.scb.scroeconnect.emailworker.dto.TransformedPayloadDTO;
import com.scb.scroeconnect.emailworker.entity.ConnectEventEmailConfig;
import com.scb.scroeconnect.emailworker.entity.ConnectNotificationDelivery;
import com.scb.scroeconnect.emailworker.enums.DeliveryStatus;
import com.scb.scroeconnect.emailworker.repository.ConnectEventEmailConfigRepository;
import com.scb.scroeconnect.emailworker.repository.ConnectNotificationDeliveryRepository;
//import com.scb.scroeconnect.emailworker.service.asyncservice.EmailAsyncProcessorService;
import com.scb.scroeconnect.emailworker.util.RetryHandler;
import com.scb.scroeconnect.emailworker.util.SaveFinalPayloadUtil;
import jakarta.transaction.Transactional;
import lombok.extern.log4j.Log4j2;
import org.apache.logging.log4j.LogManager;
import org.apache.logging.log4j.Logger;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.http.*;
import org.springframework.stereotype.Service;

import java.nio.charset.StandardCharsets;
import java.util.Base64;
import java.util.Optional;
import java.util.UUID;

@Log4j2
@Service
public class EmailWorkerService {
    private static final ObjectMapper OBJECT_MAPPER = new ObjectMapper();
    private static final Logger logger = LogManager.getLogger(EmailWorkerService.class);

    private final ConnectNotificationDeliveryRepository connectNotificationDeliveryRepository;
    private final ConnectEventEmailConfigRepository connectEventEmailConfigRepository;
    private final RetryableRestTemplate restTemplate;
    private final EmailWorkerConfig emailWorkerConfig;

    @Autowired
    private final RetryHandler retryHandler;

    private final SaveFinalPayloadUtil saveFinalPayloadUtil;

   // private final EmailAsyncProcessorService emailAsyncProcessorService;

    public EmailWorkerService(ConnectEventEmailConfigRepository connectEventEmailConfigRepository, RetryableRestTemplate restTemplate, EmailWorkerConfig emailWorkerConfig, ConnectNotificationDeliveryRepository connectNotificationDeliveryRepository,RetryHandler retryHandler, SaveFinalPayloadUtil saveFinalPayloadUtil) {
        this.connectEventEmailConfigRepository = connectEventEmailConfigRepository;
        this.restTemplate = restTemplate;
        this.emailWorkerConfig = emailWorkerConfig;
        this.connectNotificationDeliveryRepository = connectNotificationDeliveryRepository;
        //this.emailAsyncProcessorService = emailAsyncProcessorService;
        this.retryHandler=retryHandler;
        this.saveFinalPayloadUtil=saveFinalPayloadUtil;

    }

    @Transactional
    public void sendEmailNotification(ConnectNotificationDelivery connectNotificationDelivery) throws JsonProcessingException {
        logger.info("Processing email notification for delivery ID: {}", connectNotificationDelivery.getId());

        // Get the final payload
        EmailRequestDTO finalPayload = getFinalPayload(connectNotificationDelivery);

        // Send the email
        boolean emailSent = sendEmail(finalPayload,connectNotificationDelivery.getNotificationEvent().getEventId());
        if (emailSent) {
            logger.info("Email sent successfully for delivery ID: {}", connectNotificationDelivery.getId());
            connectNotificationDeliveryRepository.updateStatusById(connectNotificationDelivery.getId(), DeliveryStatus.SENT.toString());
            saveFinalPayloadUtil.saveFinalPayload(connectNotificationDelivery,finalPayload);
        } else {
            logger.warn("Failed to send email for delivery ID: {}", connectNotificationDelivery.getId());
            retryHandler.handleFailure(connectNotificationDelivery);

        }
    }

    public EmailRequestDTO getFinalPayload(ConnectNotificationDelivery delivery) throws JsonProcessingException {
        logger.info("Generating final payload for delivery ID: {}", delivery.getId());

        // Deserialize transformedPayload into TransformedPayloadDTO
        String transformedPayload = delivery.getTransformedPayload();
        if (transformedPayload == null) {
            throw new IllegalStateException("Transformed payload is null");
        }
        TransformedPayloadDTO payload = OBJECT_MAPPER.readValue(transformedPayload, TransformedPayloadDTO.class);

        // Retrieve email configuration
        Optional<ConnectEventEmailConfig> connectEventEmailConfigOptional = connectEventEmailConfigRepository.findByRecipientId(delivery.getRecipient().getId());
        if (connectEventEmailConfigOptional.isEmpty()) {
            throw new IllegalStateException("No email configuration found for recipient ID: " + delivery.getRecipient().getId());
        }
        ConnectEventEmailConfig connectEventEmailConfig = connectEventEmailConfigOptional.get();

        // Extract contentBody from TransformedPayloadDTO and encode as Base64
        ContentBodyDTO contentBodyDTO = payload.getContentBody();
        String json = OBJECT_MAPPER.writeValueAsString(contentBodyDTO);
        String contentBody = Base64.getEncoder().encodeToString(json.getBytes(StandardCharsets.UTF_8));

        // Construct EmailRequestDTO
        EmailRequestDTO finalPayload = new EmailRequestDTO();
        finalPayload.set_id("2001");
        finalPayload.setCountry(payload.getCountry());
        finalPayload.setRecipients(connectEventEmailConfig.getRecipients());
        finalPayload.setCc(connectEventEmailConfig.getCc());
        finalPayload.setBcc(connectEventEmailConfig.getBcc());
        finalPayload.setReplyTo(connectEventEmailConfig.getReplyTo());
        finalPayload.setNotificationType(payload.getNotificationType());
        finalPayload.setSubject(payload.getSubject());
        finalPayload.setContentType(payload.getContentType());
        finalPayload.setContentBody(contentBody);
        finalPayload.setEncoding("Base64");
        finalPayload.setPriority(payload.getPriority());
        finalPayload.setAttachments(null); // For now

        // Remove null fields
        removeNullFields(finalPayload);

        logger.info("Generated final payload: {}", finalPayload);
        return finalPayload;
    }

    private boolean sendEmail(EmailRequestDTO finalPayload, UUID trackingId) {
        HttpHeaders headers = new HttpHeaders();
        headers.setContentType(MediaType.APPLICATION_JSON);
        headers.set("TrackingId", trackingId.toString());

        HttpEntity<EmailRequestDTO> requestEntity = new HttpEntity<>(finalPayload, headers);
        ResponseEntity<String> response = restTemplate.exchange(
                    emailWorkerConfig.getSendEmailApi(),
                    HttpMethod.POST,
                    requestEntity);
        System.out.println(finalPayload.toString());
        if (!response.getStatusCode().is2xxSuccessful()) {
            log.error("Failed to send email. Response: {}", response.getBody());
            //throw new RuntimeException("Failed to send email");
            return false;
        }
        return true;

    }

    private void removeNullFields(EmailRequestDTO finalPayload) {
        try {
            ObjectNode objectNode = OBJECT_MAPPER.valueToTree(finalPayload);

            // Remove all fields with null values
            objectNode.fields().forEachRemaining(entry -> {
                if (entry.getValue().isNull()) {
                    objectNode.remove(entry.getKey());
                }
            });

            // Update the finalPayload object with the modified ObjectNode
            OBJECT_MAPPER.readerForUpdating(finalPayload).readValue(objectNode);
        } catch (Exception e) {
            throw new RuntimeException("Failed to remove null fields", e);
        }
    }
}

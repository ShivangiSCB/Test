package com.scb.scroeconnect.emailworker.entity;

import com.scb.scroeconnect.emailworker.converter.EmailPayloadConverter;
import com.scb.scroeconnect.emailworker.dto.EmailPayloadDTO;
import jakarta.persistence.*;

import java.sql.Timestamp;

@Entity
@Table(name = "connect_notification_delivery")
public class ConnectNotificationDelivery {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    @Column(name = "id")
    private Long id;

//    @ManyToOne(fetch = FetchType.LAZY)
//    @JoinColumn(name = "recipient_id", referencedColumnName = "id", nullable = false)
    @Column(name = "recipient_id")
    private Long recipientId;

    @Column(name = "delivery_mode", nullable = false)
    private String deliveryMode;

    @Convert(converter = EmailPayloadConverter.class)
    @Column(name = "transformed_payload", columnDefinition = "TEXT")
    private EmailPayloadDTO transformedPayload;

    @Column(nullable = false)
    private String status;

    @Column(name = "retry_count", nullable = false)
    private int retryCount;

    @Column(name = "available_at", nullable = false)
    private Timestamp availableAt;

    public ConnectNotificationDelivery() {
    }

    public ConnectNotificationDelivery(Long recipientId, String deliveryMode, EmailPayloadDTO transformedPayload, String status, int retryCount, Timestamp availableAt) {
        this.recipientId = recipientId;
        this.deliveryMode = deliveryMode;
        this.transformedPayload = transformedPayload;
        this.status = status;
        this.retryCount = retryCount;
        this.availableAt = availableAt;
    }


    public Long getId() {
        return id;
    }

    public void setId(Long id) {
        this.id = id;
    }

    public Long getRecipientId() {
        return recipientId;
    }

    public void setRecipientId(Long recipientId) {
        this.recipientId = recipientId;
    }

    public String getDeliveryMode() {
        return deliveryMode;
    }

    public void setDeliveryMode(String deliveryMode) {
        this.deliveryMode = deliveryMode;
    }

    public EmailPayloadDTO getTransformedPayload() {
        return transformedPayload;
    }

    public void setTransformedPayload(EmailPayloadDTO transformedPayload) {
        this.transformedPayload = transformedPayload;
    }

    public String getStatus() {
        return status;
    }

    public void setStatus(String status) {
        this.status = status;
    }

    public int getRetryCount() {
        return retryCount;
    }

    public void setRetryCount(int retryCount) {
        this.retryCount = retryCount;
    }

    public Timestamp getAvailableAt() {
        return availableAt;
    }

    public void setAvailableAt(Timestamp availableAt) {
        this.availableAt = availableAt;
    }
}

package com.scb.scroeconnect.emailworker.entity;

import com.scb.scroeconnect.emailworker.converter.StringListConverter;
import jakarta.persistence.*;

import java.util.List;

@Entity
@Table(name = "connect_event_email_config")
public class ConnectEventEmailConfig {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    @Column(name = "email_config_id")
    private int email_config_id;

    @Column(name = "recipients")
    @Convert(converter = StringListConverter.class)
    private List<String> recipients;

    @Column(name = "cc")
    @Convert(converter = StringListConverter.class)
    private List<String> cc;

    @Column(name = "bcc")
    @Convert(converter = StringListConverter.class)
    private List<String> bcc;

    @Column(name = "reply_to")
    private String replyTo;

    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "recipient_id", referencedColumnName = "id", nullable = false)
    private ConnectNotificationRecipient recipient;

    public ConnectEventEmailConfig(int email_config_id, List<String> recipients, List<String> cc, List<String> bcc, String replyTo) {
        this.email_config_id = email_config_id;
        this.recipients = recipients;
        this.cc = cc;
        this.bcc = bcc;
        this.replyTo = replyTo;
    }

    public int getEmail_config_id() {
        return email_config_id;
    }

    public void setEmail_config_id(int email_config_id) {
        this.email_config_id = email_config_id;
    }

    public List<String> getRecipients() {
        return recipients;
    }

    public void setRecipients(List<String> recipients) {
        this.recipients = recipients;
    }

    public List<String> getCc() {
        return cc;
    }

    public void setCc(List<String> cc) {
        this.cc = cc;
    }

    public List<String> getBcc() {
        return bcc;
    }

    public void setBcc(List<String> bcc) {
        this.bcc = bcc;
    }

    public String getReplyTo() {
        return replyTo;
    }

    public void setReplyTo(String replyTo) {
        this.replyTo = replyTo;
    }

    public ConnectNotificationRecipient getRecipient() {
        return recipient;
    }

    public void setRecipient(ConnectNotificationRecipient recipient) {
        this.recipient = recipient;
    }
}

package com.scb.scroeconnect.emailworker.dto;

import com.fasterxml.jackson.databind.JsonNode;

import java.util.List;

public class EmailRequestDTO {
    private String _id;
    private String country;
    private List<String> recipients;
    private List<String> cc;
    private List<String> bcc;
    private String replyTo;
    private String notificationType;
    private String subject;
    private String contentType;
    private String contentBody;
    private String encoding;
    private String priority;
    private List<Object> attachments;

    public EmailRequestDTO() {
    }

    public String get_id() {
        return _id;
    }

    public void set_id(String _id) {
        this._id = _id;
    }

    public String getCountry() {
        return country;
    }

    public void setCountry(String country) {
        this.country = country;
    }

    public List<String> getRecipients() {
        return recipients;
    }

    public void setRecipients(List<String> recipients) {
        this.recipients = recipients;
    }

    public List<String> getCc() {
        return cc;
    }

    public void setCc(List<String> cc) {
        this.cc = cc;
    }

    public List<String> getBcc() {
        return bcc;
    }

    public void setBcc(List<String> bcc) {
        this.bcc = bcc;
    }

    public String getReplyTo() {
        return replyTo;
    }

    public void setReplyTo(String replyTo) {
        this.replyTo = replyTo;
    }

    public String getNotificationType() {
        return notificationType;
    }

    public void setNotificationType(String notificationType) {
        this.notificationType = notificationType;
    }

    public String getSubject() {
        return subject;
    }

    public void setSubject(String subject) {
        this.subject = subject;
    }

    public String getContentType() {
        return contentType;
    }

    public void setContentType(String contentType) {
        this.contentType = contentType;
    }

    public String getContentBody() {
        return contentBody;
    }

    public void setContentBody(String contentBody) {
        this.contentBody = contentBody;
    }

    public String getEncoding() {
        return encoding;
    }

    public void setEncoding(String encoding) {
        this.encoding = encoding;
    }

    public String getPriority() {
        return priority;
    }

    public void setPriority(String priority) {
        this.priority = priority;
    }

    public List<Object> getAttachments() {
        return attachments;
    }

    public void setAttachments(List<Object> attachments) {
        this.attachments = attachments;
    }
}

package com.scb.scroeconnect.emailworker.config;

import com.scb.scroeconnect.emailworker.exception.RetryableApiException;
import lombok.extern.log4j.Log4j2;
import org.springframework.context.annotation.Configuration;
import org.springframework.http.HttpEntity;
import org.springframework.http.HttpMethod;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.retry.annotation.EnableRetry;
import org.springframework.retry.annotation.Recover;
import org.springframework.retry.annotation.Retryable;
import org.springframework.web.client.RestTemplate;

@EnableRetry
@Configuration
@Log4j2
public class RetryableRestTemplate {
    private final RestTemplate restTemplate;

    public RetryableRestTemplate(RestTemplate restTemplate) {
        this.restTemplate = restTemplate;
    }

    @Retryable(retryFor = RetryableApiException.class)
    public ResponseEntity<String> exchange(String url, HttpMethod status, HttpEntity<?> requestEntity) {
        return restTemplate.exchange(url, status, requestEntity, String.class);
    }

    @Retryable(retryFor = RetryableApiException.class)
    public <T> ResponseEntity<T> getForEntity(String url, Class<T> responseObject) {
        return restTemplate.getForEntity(url, responseObject);
    }

    @Recover
    public ResponseEntity<String> recover(RetryableApiException r, String url, HttpMethod status, HttpEntity<?> requestEntity) {
        return new ResponseEntity(r.getMessage(), HttpStatus.INTERNAL_SERVER_ERROR);
    }

    @Recover
    public ResponseEntity<String> recover(Exception e, String url, HttpMethod status, HttpEntity<?> requestEntity) {
        log.error(requestEntity, e);
        return new ResponseEntity(e.getMessage(), HttpStatus.INTERNAL_SERVER_ERROR);
    }
}

package com.scb.scroeconnect.solaceworker.config;

import com.scb.scroeconnect.solaceworker.entity.ConnectSolaceConfig;
import com.scb.scroeconnect.solaceworker.repository.ConnectSolaceConfigRepository;
import com.scb.scroeconnect.solaceworker.repository.ConnectSolaceWorkerRepository;
import com.solacesystems.jcsmp.*;
import com.solacesystems.jms.SolConnectionFactory;
import com.solacesystems.jms.SolJmsUtility;
import com.solacesystems.jms.message.SolMessage;
import lombok.extern.log4j.Log4j2;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.beans.factory.annotation.Qualifier;
import org.springframework.context.ApplicationListener;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Lazy;
import org.springframework.context.event.ContextClosedEvent;
import org.springframework.stereotype.Component;

import javax.jms.Connection;
import javax.jms.Destination;
import javax.jms.JMSException;
import javax.jms.MessageProducer;
import javax.jms.Session;
import java.util.Map;

@Log4j2
@Component
public class SolaceConnectionConfig implements ApplicationListener<ContextClosedEvent> {

    private final ConnectSolaceConfigRepository connectSolaceConfigRepository;

    private final SolacePropertiesConstant solacePropertiesConstant;

    @Lazy
    @Autowired
    @Qualifier("rcmsSession")
    public Session session;

    @Lazy
    @Autowired
    @Qualifier("rcmsConnection")
    public Connection connection;

    public SolaceConnectionConfig(ConnectSolaceConfigRepository connectSolaceConfigRepository, SolacePropertiesConstant solacePropertiesConstant) {
        this.connectSolaceConfigRepository = connectSolaceConfigRepository;
        this.solacePropertiesConstant = solacePropertiesConstant;
    }

    @Bean("rcmsSolConnectionFactory")
    public SolConnectionFactory createSolConnectionFactory() throws Exception {
        ConnectSolaceConfig connectSolaceConfig = connectSolaceConfigRepository.findFirstByActive("Y").orElseThrow(() -> new RuntimeException("No active Solace configuration found"));
        Map<String, String> queue = solacePropertiesConstant.getQueue();
        Map<String, String> ssl = solacePropertiesConstant.getSsl();

        SolConnectionFactory cf = SolJmsUtility.createConnectionFactory();
        cf.setVPN(connectSolaceConfig.getVpn());
        cf.setHost(connectSolaceConfig.getHostname());
        cf.setUsername(connectSolaceConfig.getUsername());
        cf.setPassword(connectSolaceConfig.getPassword());
        cf.setConnectRetries(solacePropertiesConstant.getConnectRetries());
        cf.setConnectRetriesPerHost(solacePropertiesConstant.getConnectRetriesPerHost());
        cf.setConnectTimeoutInMillis(solacePropertiesConstant.getConnectTimeoutInMillis());
        cf.setClientID(connectSolaceConfig.getClientId());

        cf.setSSLTrustStore(ssl.get("truststorePath"));
        cf.setSSLTrustStorePassword(ssl.get("truststorePassword"));
        cf.setSSLTrustStoreFormat(ssl.get("truststoreType"));
        cf.setSSLKeyStore(ssl.get("keystorePath"));
        cf.setSSLKeyStorePassword(ssl.get("keystorePassword"));
        cf.setSSLKeyStoreFormat(ssl.get("keystoreType"));
        cf.setAuthenticationScheme("AUTHENTICATION_SCHEME_CLIENT_CERTIFICATE");
        log.info("Host: {}", connectSolaceConfig.getHostname());
        log.info("Sol Connection Properties: {}", cf.getHost());
        return cf;
    }

    @Bean("rcmsConnection")
    public Connection createConnection(@Qualifier("rcmsSolConnectionFactory") SolConnectionFactory cf) throws Exception {
        return cf.createConnection();
    }

    @Bean("rcmsSession")
    public javax.jms.Session createSession(@Qualifier("rcmsConnection") Connection connection) throws Exception {
        return connection.createSession(false, javax.jms.Session.CLIENT_ACKNOWLEDGE);
    }

    @Override
    public void onApplicationEvent(ContextClosedEvent event) {
        if (session != null)
            try {
                session.close();
            } catch (JMSException e) {
                log.error("Error while closing session", e);
            }
        if (connection != null)
            try {
                connection.close();
            } catch (JMSException e) {
                log.error("Error while closing connection", e);
            }
    }

    public void sendMessage(String topicName, String message, String caseRef) throws JMSException {
        Destination destination = session.createTopic(topicName);
        MessageProducer producer = session.createProducer(destination);
        SolMessage textMessage = (SolMessage) session.createTextMessage((String) message);
        textMessage.setJMSTimestamp(System.currentTimeMillis());
        textMessage.setJMSCorrelationID(caseRef);
        producer.send(textMessage);
        log.info(textMessage.getJMSMessageID());
        if (producer != null) producer.close();
    }
}

#RCMS Solace configurations
solace.rcms.queue.clientId=51241-xcro
solace.rcms.queue.username=51241-xcro
solace.rcms.queue.password=51241-xcro
solace.rcms.queue.vpn=vpn-cs-reference-data-p1
solace.rcms.queue.hostname=tcps://vpn-cs-reference-data-p1-0-a-0.51080.app.standardchartered.com:55443,tcps://vpn-cs-reference-data-p1-0-b-0.51080.app.standardchartered.com:55443
solace.rcms.queue.connectionPrefix=scroe-rcms-conn-
solace.rcms.queue.isSSLEnabled=Y
solace.rcms.queue.cacheSize=3
solace.rcms.ssl.truststoreType=jks
solace.rcms.ssl.truststorePassword=51241-xcro
solace.rcms.ssl.truststorePath=/etc/keys/51241-solace-truststore.jks
solace.rcms.ssl.keystoreType=PKCS12
solace.rcms.ssl.keystorePassword=51241-xcro
solace.rcms.ssl.keystorePath=/etc/keys/51241-solace-keystore.jks
solace.rcms.topic=v1/51241-scroe-/vam/json.vam.v1/*/req/14733-rcms-
solace.rcms.connectRetries=5
solace.rcms.connectRetriesPerHost=5
solace.rcms.connectTimeoutInMillis=10000


Caused by: org.springframework.beans.BeanInstantiationException: Failed to instantiate [javax.jms.Connection]: Factory method 'createConnection' threw exception with message: All hosts in the host list: 'tcps://vpn-cs-reference-data-p1-0-a-0.51080.app.standardchartered.com:55443,tcps://vpn-cs-reference-data-p1-0-b-0.51080.app.standardchartered.com:55443' are not resolvable
	at org.springframework.beans.factory.support.SimpleInstantiationStrategy.instantiate(SimpleInstantiationStrategy.java:178) ~[spring-beans-6.1.21.jar:6.1.21]
	at org.springframework.beans.factory.support.ConstructorResolver.instantiate(ConstructorResolver.java:644) ~[spring-beans-6.1.21.jar:6.1.21]
	... 19 common frames omitted
Caused by: com.solacesystems.jms.ConfigurationException: All hosts in the host list: 'tcps://vpn-cs-reference-data-p1-0-a-0.51080.app.standardchartered.com:55443,tcps://vpn-cs-reference-data-p1-0-b-0.51080.app.standardchartered.com:55443' are not resolvable
	at com.solacesystems.jms.SolConnection.<init>(SolConnection.java:149) ~[sol-jms-10.6.3.jar:na]
	at com.solacesystems.jms.SolConnection.<init>(SolConnection.java:86) ~[sol-jms-10.6.3.jar:na]
	at com.solacesystems.jms.SolConnectionFactoryImpl.createConnection(SolConnectionFactoryImpl.java:112) ~[sol-jms-10.6.3.jar:na]
	at com.scb.scroeconnect.solaceworker.config.SolaceConnectionConfig.createConnection(SolaceConnectionConfig.java:79) ~[classes/:na]
